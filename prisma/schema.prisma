generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int         @id @default(autoincrement())
  email       String      @unique
  password    String?
  firstName   String
  lastName    String
  phone       String?
  firstAccess Boolean     @default(true)
  timezone    String      @default("UTC")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  admin       Boolean     @default(false)
  role        ChurchRoles @default(MEMBER)

  members      Member[]
  redes        Rede[]
  discipulados Discipulado[]
  ledCelulas   Celula[]      @relation("CelulaLeader")
  viceLedCelulas Celula[]    @relation("CelulaViceLeader")
}

enum ChurchRoles {
  PASTOR
  PRESIDENTPASTOR
  VICEPRESIDENTPASTOR
  DISCIPULADOR
  LEADER
  MEMBER
}

model Celula {
  id               Int      @id @default(autoincrement())
  name             String   @unique
  leaderUserId     Int
  viceLeaderUserId Int?
  discipuladoId    Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  members Member[]
  reports Report[]

  discipulado Discipulado? @relation(fields: [discipuladoId], references: [id])
  leader      User         @relation("CelulaLeader", fields: [leaderUserId], references: [id], onDelete: SetNull)
  viceLeader  User?        @relation("CelulaViceLeader", fields: [viceLeaderUserId], references: [id], onDelete: SetNull)

  @@index([discipuladoId])
  @@index([leaderUserId])
  @@index([viceLeaderUserId])
}

model Member {
  id            Int           @id @default(autoincrement())
  name          String
  status        MemberStatus  @default(MEMBER)
  celulaId      Int
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  userId        Int?
  maritalStatus MaritalStatus @default(SINGLE)

  attendances ReportAttendance[]

  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  celula Celula @relation(fields: [celulaId], references: [id], onDelete: NoAction)

  @@index([celulaId])
}

enum MaritalStatus {
  SINGLE
  COHABITATING
  MARRIED
  DIVORCED
  WIDOWED
}

enum MemberStatus {
  VISITOR
  MEMBER
  FA
  INACTIVE
}

model Rede {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  pastorUserId Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  discipulados Discipulado[]

  pastor User @relation(fields: [pastorUserId], references: [id], onDelete: Cascade)
}

model Discipulado {
  id                 Int      @id @default(autoincrement())
  redeId             Int
  discipuladorUserId Int
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  celulas Celula[]

  rede         Rede @relation(fields: [redeId], references: [id], onDelete: Cascade)
  discipulador User @relation(fields: [discipuladorUserId], references: [id], onDelete: Cascade)

  @@index([redeId])
  @@index([discipuladorUserId])
}

model Report {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  celulaId  Int

  celula      Celula             @relation(fields: [celulaId], references: [id], onDelete: NoAction)
  attendances ReportAttendance[]

  @@index([celulaId])
}

model ReportAttendance {
  id       Int @id @default(autoincrement())
  reportId Int
  memberId Int

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([reportId, memberId])
  @@index([reportId])
  @@index([memberId])
}
