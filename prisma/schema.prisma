generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String?
  firstName   String
  lastName    String
  phoneNumber String?
  firstAccess Boolean  @default(true)
  timezone    String   @default("UTC")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permission Permission?
  // cells where this user is the leader
  ledCells    Cell[]   @relation("CellLeader")
}

model Cell {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  leaderUserId Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  members           Member[]
  reports           Report[]
  permissionCells   PermissionCell[]
  discipulado       Discipulado? @relation(fields: [discipuladoId], references: [id])
  discipuladoId     Int?
  // relation to User as leader
  leader            User?    @relation("CellLeader", fields: [leaderUserId], references: [id], onDelete: SetNull)
}

model Member {
  id        Int      @id @default(autoincrement())
  name      String
  status    MemberStatus @default(ACTIVE)
  cellId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cell Cell @relation(fields: [cellId], references: [id], onDelete: NoAction)
  attendances ReportAttendance[]

  @@index([cellId])
}

enum MemberStatus {
  ACTIVE
  INACTIVE
}

model Permission {
  id Int @id @default(autoincrement())
  userId Int @unique
  hasGlobalCellAccess Boolean @default(false)
  canManageCells Boolean @default(false)
  canManagePermissions Boolean @default(false)
  role String? @default("USER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissionCells PermissionCell[]
  permissionNetworks PermissionNetwork[]
  permissionDiscipulados PermissionDiscipulado[]
}

model Network {
  id Int @id @default(autoincrement())
  name String @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  discipulados Discipulado[]
  permissionNetworks PermissionNetwork[]
}

// Discipulado (discipleship) groups cells and belongs to a Network
model Discipulado {
  id Int @id @default(autoincrement())
  name String
  networkId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  network Network @relation(fields: [networkId], references: [id], onDelete: Cascade)
  cells Cell[]
  permissionDiscipulados PermissionDiscipulado[]
}

// Assign a permission to manage a specific network (pastor) - optional
model PermissionNetwork {
  id Int @id @default(autoincrement())
  permissionId Int
  networkId Int

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  network Network @relation(fields: [networkId], references: [id], onDelete: Cascade)

  @@unique([permissionId, networkId])
  @@index([permissionId])
  @@index([networkId])
}

// Assign a permission to manage a specific discipulado (discipulador)
model PermissionDiscipulado {
  id Int @id @default(autoincrement())
  permissionId Int
  discipuladoId Int

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  discipulado Discipulado @relation(fields: [discipuladoId], references: [id], onDelete: Cascade)

  @@unique([permissionId, discipuladoId])
  @@index([permissionId])
  @@index([discipuladoId])
}

model PermissionCell {
  id Int @id @default(autoincrement())
  permissionId Int
  cellId Int

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  cell Cell @relation(fields: [cellId], references: [id], onDelete: Cascade)

  @@unique([permissionId, cellId])
  @@index([permissionId])
  @@index([cellId])
}

model Report {
  id Int @id @default(autoincrement())
  createdAt DateTime @default(now())
  cellId Int

  cell Cell @relation(fields: [cellId], references: [id], onDelete: NoAction)
  attendances ReportAttendance[]

  @@index([cellId])
}

model ReportAttendance {
  id Int @id @default(autoincrement())
  reportId Int
  memberId Int

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([memberId])
  @@unique([reportId, memberId])
}

