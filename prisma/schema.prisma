generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Matrix {
  id             Int      @id @default(autoincrement())
  name           String
  whatsappApiKey String?  @map("whatsapp_api_key")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  domains       MatrixDomain[]
  members       MemberMatrix[]
  celulas       Celula[]
  roles         Role[]
  ministries    Ministry[]
  winnerPaths   WinnerPath[]
  congregacoes  Congregacao[]
  redes         Rede[]
  discipulados  Discipulado[]
  reports       Report[]
  apiKeys       ApiKey[]

  @@map("matrix")
}

model MatrixDomain {
  id        Int      @id @default(autoincrement())
  domain    String   @unique
  matrixId  Int      @map("matrix_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  matrix Matrix @relation(fields: [matrixId], references: [id], onDelete: Cascade)

  @@index([matrixId])

  @@map("matrix_domain")
}

model MemberMatrix {
  id       Int @id @default(autoincrement())
  memberId Int @map("member_id")
  matrixId Int @map("matrix_id")

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  matrix Matrix @relation(fields: [matrixId], references: [id], onDelete: Cascade)

  @@unique([memberId, matrixId])
  @@index([memberId])
  @@index([matrixId])

  @@map("member_matrix")
}

model Celula {
  id                 Int      @id @default(autoincrement())
  name               String
  matrixId           Int      @map("matrix_id")
  leaderMemberId     Int      @map("leader_member_id")
  hostMemberId       Int?     @map("host_member_id")
  discipuladoId      Int      @map("discipulado_id")
  weekday            Int?
  time               String?
  
  // Address fields
  country      String?       @default("Brasil")
  zipCode      String?       @map("zip_code")
  street       String?
  streetNumber String?       @map("street_number")
  neighborhood String?
  city         String?
  complement   String?
  state        String?
  
  // Cell details
  openingDate        DateTime?  @map("opening_date")
  multiplicationDate DateTime?  @map("multiplication_date")
  hasNextHost        Boolean    @default(false) @map("has_next_host")
  type               CelulaType?
  level              CelulaLevel?
  parallelCelulaId   Int?       @map("parallel_celula_id")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  members Member[]
  reports Report[]
  leadersInTraining CelulaLeaderInTraining[]

  matrix         Matrix      @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  discipulado    Discipulado @relation(fields: [discipuladoId], references: [id])
  leader         Member      @relation("CelulaLeader", fields: [leaderMemberId], references: [id], onDelete: NoAction)
  host           Member?     @relation("CelulaHost", fields: [hostMemberId], references: [id], onDelete: NoAction)
  parallelCelula Celula?     @relation("ParallelCelulas", fields: [parallelCelulaId], references: [id], onDelete: NoAction)
  parallelOf     Celula[]    @relation("ParallelCelulas")

  @@unique([name, matrixId])
  @@index([matrixId])
  @@index([discipuladoId])
  @@index([leaderMemberId])
  @@index([hostMemberId])
  @@index([parallelCelulaId])

  @@map("celula")
}

model Role {
  id        Int      @id @default(autoincrement())
  name      String
  matrixId  Int      @map("matrix_id")
  isAdmin   Boolean  @default(false) @map("is_admin")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  // To do: Permiss√µes de tesoureiro, gerenciar landing page, gerenciar revistas, etc.

  matrix  Matrix       @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  members MemberRole[]

  @@unique([name, matrixId])
  @@index([matrixId])

  @@map("role")
}

model Ministry {
  id        Int          @id @default(autoincrement())
  name      String
  matrixId  Int          @map("matrix_id")
  type      MinistryType @default(MEMBER)
  priority  Int          @default(0)
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  matrix  Matrix   @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  members Member[]

  @@unique([name, matrixId])
  @@index([matrixId])

  @@map("ministry")
}

model WinnerPath {
  id        Int      @id @default(autoincrement())
  name      String
  matrixId  Int      @map("matrix_id")
  priority  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  matrix  Matrix   @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  members Member[]

  @@unique([name, matrixId])
  @@index([matrixId])

  @@map("winner_path")
}

model Member {
  id          Int         @id @default(autoincrement())
  
  // User/Auth fields (from old User model)
  email       String?      @unique
  password    String?
  phone       String?
  hasDefaultPassword Boolean? @map("has_default_password")
  inviteSent  Boolean      @default(false) @map("invite_sent")
  hasLoggedIn Boolean      @default(false) @map("has_logged_in")
  
  // Member info fields (from old Member model)
  name          String
  celulaId      Int?           @map("celula_id")
  isActive      Boolean        @default(true) @map("is_active")
  maritalStatus MaritalStatus  @default(SINGLE) @map("marital_status")
  
  // Personal info
  photoUrl      String?       @map("photo_url")
  gender        Gender?
  isBaptized    Boolean       @default(false) @map("is_baptized")
  baptismDate   DateTime?     @map("baptism_date")
  birthDate     DateTime?     @map("birth_date")
  registerDate  DateTime?     @map("register_date")
  spouseId      Int?          @unique @map("spouse_id")
  
  // Church info
  ministryPositionId  Int       @map("ministry_position_id")
  winnerPathId        Int?      @map("winner_path_id")
  canBeHost           Boolean   @default(false) @map("can_be_host")
  
  // Address
  country      String?       @default("Brasil")
  zipCode      String?       @map("zip_code")
  street       String?
  streetNumber String?       @map("street_number")
  neighborhood String?
  city         String?
  complement   String?
  state        String?
  
  // Access
  hasSystemAccess  Boolean    @default(false) @map("has_system_access")
  isOwner          Boolean    @default(false) @map("is_owner")
  
  // Privacy
  contactPrivacyLevel ContactPrivacyLevel @default(MY_LEADERSHIP_AND_DISCIPLES) @map("contact_privacy_level")

  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  attendances              ReportAttendance[]
  redes                    Rede[]
  discipulados             Discipulado[]
  ledCelulas               Celula[]                @relation("CelulaLeader")
  hostedCelulas            Celula[]                @relation("CelulaHost")
  congregacoesPastorGoverno Congregacao[]          @relation("CongregacaoPastorGoverno")
  congregacoesVicePresidente Congregacao[]         @relation("CongregacaoVicePresidente")
  congregacoesKidsLeader   Congregacao[]           @relation("CongregacaoKidsLeader")
  celula                   Celula?                 @relation(fields: [celulaId], references: [id], onDelete: NoAction)
  ministryPosition         Ministry                @relation(fields: [ministryPositionId], references: [id], onDelete: NoAction)
  winnerPath               WinnerPath?             @relation(fields: [winnerPathId], references: [id], onDelete: NoAction)
  spouse                   Member?                 @relation("MemberSpouse", fields: [spouseId], references: [id], onDelete: NoAction)
  spouseOf                 Member?                 @relation("MemberSpouse")
  roles                    MemberRole[]
  refreshTokens            RefreshToken[]
  createdApiKeys           ApiKey[]
  matrices                 MemberMatrix[]
  leadingInTrainingCelulas CelulaLeaderInTraining[]
  passwordResetTokens      PasswordResetToken[]
  socialMedia              MemberSocialMedia[]
  discipleOf               DiscipuladoDisciple[]

  @@index([celulaId])
  @@index([ministryPositionId])
  @@index([winnerPathId])
  @@index([spouseId])

  @@map("member")
}

model CelulaLeaderInTraining {
  id        Int      @id @default(autoincrement())
  celulaId  Int       @map("celula_id")
  memberId  Int       @map("member_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  celula Celula @relation(fields: [celulaId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([celulaId, memberId])
  @@index([celulaId])
  @@index([memberId])

  @@map("celula_leader_in_training")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  COHABITATING
  MARRIED
  DIVORCED
  WIDOWED
}

enum MinistryType {
  PRESIDENT_PASTOR
  PASTOR
  DISCIPULADOR
  LEADER
  LEADER_IN_TRAINING
  MEMBER
  REGULAR_ATTENDEE
  VISITOR
}

enum ContactPrivacyLevel {
  MY_LEADERSHIP_AND_DISCIPLES
  ALL_DISCIPULADO
  ALL_REDE
  ALL_CONGREGACAO
  ALL
}
enum CelulaType {
  YOUNG
  ADULT
  TEENAGER
  CHILDISH
  KIDS
}

enum CelulaLevel {
  EVANGELISM
  EDIFICATION
  COMMUNION
  MULTIPLICATION
  UNKNOWN
}

enum ReportType {
  CELULA
  CULTO
}

model Congregacao {
  id                      Int      @id @default(autoincrement())
  name                    String
  matrixId                Int      @map("matrix_id")
  pastorGovernoMemberId   Int      @map("pastor_governo_member_id")
  vicePresidenteMemberId  Int?     @map("vice_presidente_member_id")
  kidsLeaderMemberId      Int?     @map("kids_leader_member_id")
  isPrincipal             Boolean  @default(false) @map("is_principal")
  
  // Address fields
  country      String?       @default("Brasil")
  zipCode      String?       @map("zip_code")
  street       String?
  streetNumber String?       @map("street_number")
  neighborhood String?
  city         String?
  complement   String?
  state        String?
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  matrix             Matrix   @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  pastorGoverno      Member   @relation("CongregacaoPastorGoverno", fields: [pastorGovernoMemberId], references: [id], onDelete: NoAction)
  vicePresidente     Member?  @relation("CongregacaoVicePresidente", fields: [vicePresidenteMemberId], references: [id], onDelete: NoAction)
  kidsLeader         Member?  @relation("CongregacaoKidsLeader", fields: [kidsLeaderMemberId], references: [id], onDelete: NoAction)
  redes              Rede[]

  @@unique([name, matrixId])
  @@index([matrixId])
  @@index([pastorGovernoMemberId])
  @@index([vicePresidenteMemberId])
  @@index([kidsLeaderMemberId])

  @@map("congregacao")
}

model Rede {
  id             Int      @id @default(autoincrement())
  name           String
  matrixId       Int      @map("matrix_id")
  congregacaoId  Int      @map("congregacao_id")
  pastorMemberId Int      @map("pastor_member_id")
  isKids         Boolean  @default(false) @map("is_kids")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  matrix       Matrix      @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  congregacao  Congregacao @relation(fields: [congregacaoId], references: [id], onDelete: NoAction)
  discipulados Discipulado[]
  pastor       Member      @relation(fields: [pastorMemberId], references: [id], onDelete: NoAction)

  @@index([matrixId])
  @@index([congregacaoId])

  @@map("rede")
}

model Discipulado {
  id                 Int      @id @default(autoincrement())
  matrixId           Int      @map("matrix_id")
  redeId             Int      @map("rede_id")
  discipuladorMemberId Int    @map("discipulador_member_id")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  celulas   Celula[]
  disciples DiscipuladoDisciple[]

  matrix       Matrix @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  rede         Rede   @relation(fields: [redeId], references: [id], onDelete: NoAction)
  discipulador Member @relation(fields: [discipuladorMemberId], references: [id], onDelete: NoAction)

  @@index([matrixId])
  @@index([redeId])
  @@index([discipuladorMemberId])

  @@map("discipulado")
}

model DiscipuladoDisciple {
  id            Int      @id @default(autoincrement())
  discipuladoId Int      @map("discipulado_id")
  memberId      Int      @map("member_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  discipulado Discipulado @relation(fields: [discipuladoId], references: [id], onDelete: Cascade)
  member      Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([discipuladoId, memberId])
  @@index([discipuladoId])
  @@index([memberId])

  @@map("discipulado_disciple")
}

model Report {
  id        Int        @id @default(autoincrement())
  matrixId  Int        @map("matrix_id")
  createdAt DateTime   @default(now()) @map("created_at")
  celulaId  Int        @map("celula_id")
  type      ReportType @default(CELULA)

  matrix      Matrix             @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  celula      Celula             @relation(fields: [celulaId], references: [id], onDelete: NoAction)
  attendances ReportAttendance[]

  @@index([matrixId])
  @@index([celulaId])

  @@map("report")
}

model ReportAttendance {
  id       Int @id @default(autoincrement())
  reportId Int @map("report_id")
  memberId Int @map("member_id")

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: NoAction)

  @@unique([reportId, memberId])
  @@index([reportId])
  @@index([memberId])

  @@map("report_attendance")
}

model MemberRole {
  id       Int @id @default(autoincrement())
  memberId Int @map("member_id")
  roleId   Int @map("role_id")

  member Member @relation(fields: [memberId], references: [id], onDelete: NoAction)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: NoAction)

  @@unique([memberId, roleId])
  @@index([memberId])
  @@index([roleId])

  @@map("member_role")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  memberId  Int      @map("member_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  isRevoked Boolean  @default(false) @map("is_revoked")

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([token])

  @@map("refresh_token")
}

model ApiKey {
  id          Int      @id @default(autoincrement())
  name        String
  matrixId    Int      @map("matrix_id")
  key         String   @unique
  isActive    Boolean  @default(true) @map("is_active")
  createdById Int      @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  lastUsedAt  DateTime? @map("last_used_at")

  matrix    Matrix @relation(fields: [matrixId], references: [id], onDelete: NoAction)
  createdBy Member @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([matrixId])
  @@index([key])
  @@index([createdById])

  @@map("api_key")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  memberId  Int      @map("member_id")
  expiresAt DateTime @map("expires_at")
  isUsed    Boolean  @default(false) @map("is_used")
  createdAt DateTime @default(now()) @map("created_at")

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([token])

  @@map("password_reset_token")
}

model MemberSocialMedia {
  id        Int      @id @default(autoincrement())
  memberId  Int      @map("member_id")
  type      String   // Tipo da rede social: INSTAGRAM, FACEBOOK, TWITTER, WHATSAPP, LINKEDIN, TIKTOK, YOUTUBE, etc.
  username  String   // Username, URL ou identificador
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([type])

  @@map("member_social_media")
}

